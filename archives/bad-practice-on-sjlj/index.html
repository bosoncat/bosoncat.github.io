<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SjLj (setjmp/longjmp) ä¸€æ¬¡é”™è¯¯çš„ä½¿ç”¨ | Xing GUO&#39;s Site</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">$Home</a></li>
      
      <li><a href="/archives/">Archives</a></li>
      
      <li><a href="/links/">Links</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">SjLj (setjmp/longjmp) ä¸€æ¬¡é”™è¯¯çš„ä½¿ç”¨</span></h1>

<h2 class="date">2019/06/15</h2>
</div>

<main>
<p>å‰å‡ å¤©åœ¨ä¸ºä¸€ä¸ªå…³äº LLVM IR çš„<a href="https://mapping-high-level-constructs-to-llvm-ir.readthedocs.io/en/latest/">æ•™ç¨‹</a> å‡çº§è¯­æ³•çš„æ—¶å€™ï¼Œå‘ç°æ•™ç¨‹ä¸­ä½¿ç”¨ <code>SjLj</code> çš„åœ°æ–¹æœ‰ç‚¹å°é—®é¢˜ã€‚</p>

<h3 id="ç®€ä»‹">ç®€ä»‹</h3>

<p>åœ¨æ•™ç¨‹ä¸­ï¼Œæœ‰ä¸€æ®µä»£ç æ˜¯è¿™æ ·çš„ï¼Œä½œè€…ç›´æ¥å°†ä¸€ä¸ªæŒ‡å‘ <code>%Exception</code> ç±»å‹çš„æŒ‡é’ˆçš„åœ°å€è½¬ä¸ºäº† <code>i32</code> (32 ä½çš„æ•´æ•°)ï¼Œç„¶åä¼ é€’ç»™äº† <code>longjmp()</code> å‡½æ•°ã€‚åé¢åœ¨ä½¿ç”¨è¿™ä¸ªæŒ‡é’ˆçš„æ—¶å€™è¿˜è¦åˆ©ç”¨ <code>inttoptr</code> æ¥æ¢å¤è¿™ä¸ªæŒ‡é’ˆã€‚<a href="https://github.com/f0rki/mapping-high-level-constructs-to-llvm-ir/blob/master/exception-handling/listings/setjmp_longjmp.ll">æºä»£ç </a></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-llvm" data-lang="llvm">...
%5 = <span style="color:#a2f;font-weight:bold">ptrtoint</span> <span style="color:#b8860b">%Exception</span> %3 <span style="color:#a2f;font-weight:bold">to</span> <span style="color:#a2f;font-weight:bold">i32</span>
<span style="color:#a2f;font-weight:bold">call</span> <span style="color:#0b0;font-weight:bold">void</span> @longjmp(<span style="color:#b8860b">%jmp_buf</span>* <span style="color:#b8860b">%throw</span>, <span style="color:#a2f;font-weight:bold">i32</span> %5)
...
<span style="color:#b8860b">%status</span> = <span style="color:#a2f;font-weight:bold">call</span> <span style="color:#a2f;font-weight:bold">i32</span> @setjmp(<span style="color:#b8860b">%jmp_buf</span>* <span style="color:#b8860b">%env</span>)
...
%6 = <span style="color:#a2f;font-weight:bold">inttoptr</span> <span style="color:#a2f;font-weight:bold">i32</span> <span style="color:#b8860b">%status</span> <span style="color:#a2f;font-weight:bold">to</span> <span style="color:#b8860b">%Exception</span>*</code></pre></div>
<p>è¿™æ ·åšçš„é—®é¢˜åœ¨äºæ²¡åŠæ³•åœ¨ 64 ä½ç³»ç»Ÿä¸­ (æŒ‡é’ˆä¸º 64 ä½)ï¼Œè¿è¡Œä»¥ä¸Šä»£ç ï¼Œè€Œä¸”åœ¨ç¨‹åºä¸­ä»¥æ•´æ•°çš„å½¢å¼æ¥ä¼ é€’æŒ‡é’ˆæ˜¯å¾ˆå±é™©çš„ã€‚è¿™ä¸€ç‚¹ä¹Ÿå‘ä½œè€…å¾—åˆ°äº†<a href="https://github.com/f0rki/mapping-high-level-constructs-to-llvm-ir/issues/30">è€ƒè¯</a></p>

<h3 id="ä½¿ç”¨-sjlj-è¿›è¡Œå¼‚å¸¸å¤„ç†">ä½¿ç”¨ SjLj è¿›è¡Œå¼‚å¸¸å¤„ç†</h3>

<p>äº‹å®ä¸Šï¼Œ<code>SjLj</code> åœ¨ C ä¸­ä½œä¸ºå¼‚å¸¸å¤„ç†çš„ä½¿ç”¨è¿˜ç®—æ¯”è¾ƒå¸¸è§ã€‚é€šå¸¸åœ¨æœ‰å¯èƒ½äº§ç”Ÿå¼‚å¸¸çš„åœ°æ–¹è°ƒç”¨ <code>setjmp(jmp_buf env);</code> å°†å¯„å­˜å™¨çš„ä¿¡æ¯ä¿å­˜åˆ° <code>jmp_buf env</code> ä¸­ï¼Œç„¶ååœ¨æŠ›å‡ºå¼‚å¸¸çš„åœ°æ–¹è°ƒç”¨ <code>longjmp(jmp_buf env, int val);</code> æ¢å¤å¯„å­˜å™¨ä¿¡æ¯ï¼Œå›åˆ°è°ƒç”¨ <code>setjmp()</code> çš„åœ°æ–¹ï¼Œå¹¶ä¸” <code>int val</code> ä¼šä½œä¸º <code>setjmp()</code> çš„è¿”å›å€¼ã€‚é€šå¸¸æˆ‘ä»¬ä¼šä½¿ç”¨ <code>int val</code> æ¥ä¼ é€’ <code>error_code</code> è€Œä¸æ˜¯æŒ‡é’ˆåœ°å€ã€‚ä¸€ä¸ªç®€å•çš„ä¾‹å­</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#080">#include</span> <span style="color:#080">&lt;setjmp.h&gt;</span><span style="color:#080">
</span><span style="color:#080">#include</span> <span style="color:#080">&lt;stdio.h&gt;</span><span style="color:#080">
</span><span style="color:#080"></span>
<span style="color:#a2f;font-weight:bold">static</span> jmp_buf env;

<span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">throw_exception</span>() {
    longjmp(env, <span style="color:#666">42</span>);
}

<span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">first</span>() {
    throw_exception();
}

<span style="color:#0b0;font-weight:bold">int</span> <span style="color:#00a000">main</span>() {
    <span style="color:#0b0;font-weight:bold">int</span> status <span style="color:#666">=</span> setjmp(env);
    <span style="color:#a2f;font-weight:bold">if</span> (status <span style="color:#666">==</span> <span style="color:#666">0</span>) {
        <span style="color:#080;font-style:italic">// try first()
</span><span style="color:#080;font-style:italic"></span>        first(); <span style="color:#080;font-style:italic">// throw exception
</span><span style="color:#080;font-style:italic"></span>        <span style="color:#080;font-style:italic">// never reach
</span><span style="color:#080;font-style:italic"></span>    } <span style="color:#a2f;font-weight:bold">else</span> {
        <span style="color:#080;font-style:italic">// catch exception
</span><span style="color:#080;font-style:italic"></span>        fprintf(stderr, <span style="color:#b44">&#34;Exception caught, error code: %d</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">&#34;</span>, status);
    }

    <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#666">0</span>;
}</code></pre></div>
<h3 id="ç°å®ç”Ÿæ´»ä¸­çš„-sjlj-real-world-sjlj">ç°å®ç”Ÿæ´»ä¸­çš„ SjLj (Real World SjLj)</h3>

<p>å…¶å®ä»ä¸Šé¢çš„ ğŸŒ°(ä¾‹å­) ä¸­ï¼Œå¯ä»¥è”æƒ³åˆ°ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥åˆ©ç”¨ SjLj æ„å»º C ä¸­çš„ <code>try-catch block</code>ï¼Ÿå®é™…ä¸Šå·²ç»æœ‰äººä¸ºæˆ‘ä»¬å®Œæˆäº†è¿™ä¸ªå·¥ä½œã€‚ç®€å•çš„æ¥è¯´ä½¿ç”¨å®å®šä¹‰ä¸€äº›ä¸œè¥¿å³å¯å®Œæˆè¿™æ ·çš„ä»»åŠ¡ã€‚æˆ‘è‡ªå·±å°è¯•åšäº†ä¸€ä¸ªç®€å•çš„ç©å…·</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#080">#include</span> <span style="color:#080">&lt;setjmp.h&gt;</span><span style="color:#080">
</span><span style="color:#080">#include</span> <span style="color:#080">&lt;stdio.h&gt;</span><span style="color:#080">
</span><span style="color:#080"></span>
<span style="color:#080">#define TRY      do { jmp_buf my_env__; int val = setjmp(my_env__); if (val == 0)
</span><span style="color:#080">#define CATCH(X) else { int X = val;
</span><span style="color:#080">#define THROW(X) longjmp(my_env__, X)
</span><span style="color:#080">#define ENDTRY   } } while(0)
</span><span style="color:#080"></span>
<span style="color:#0b0;font-weight:bold">int</span> <span style="color:#00a000">main</span>() {
    TRY {
        printf(<span style="color:#b44">&#34;In try block</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">&#34;</span>);
        THROW(<span style="color:#666">42</span>);
        printf(<span style="color:#b44">&#34;Cannot reach</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">&#34;</span>);
    } CATCH(e) {
        printf(<span style="color:#b44">&#34;Got Exception code: %d</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#b44">&#34;</span>, e);
    }
    ENDTRY;

    <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#666">0</span>;
}</code></pre></div>
<p>ä¸€ä¸ªå«åš <code>CException</code> çš„åº“å°±æ˜¯åˆ©ç”¨äº†è¿™ä¸ªæƒ³æ³• <a href="https://github.com/ThrowTheSwitch/CException/">link</a></p>

<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>

<p>[1] <a href="https://en.wikipedia.org/wiki/Setjmp.h">setjmp.h &ndash; Wikipedia</a></p>

<p>[2] <a href="http://www.throwtheswitch.org/cexception">CException</a></p>
</main>

<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "higuoxing" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  <footer>
  <script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  
  <hr/>
  &copy;  2017 &ndash; 2020 <a href="https://higuoxing.com/">Xing GUO</a> | Powered by <a href="https://github.com/gohugoio/hugo">Hugo</a> | Theme: <a href="https://github.com/yihui/hugo-xmin">Xmin</a>
  
  </footer>
  </body>
</html>

